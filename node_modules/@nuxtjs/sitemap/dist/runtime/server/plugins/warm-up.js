import { withLeadingSlash } from "ufo";
import { defineNitroPlugin } from "nitropack/runtime";
import { useSitemapRuntimeConfig } from "../utils.js";
export default defineNitroPlugin((nitroApp) => {
  const { sitemaps } = useSitemapRuntimeConfig();
  const queue = [];
  const sitemapsWithRoutes = Object.entries(sitemaps).filter(([, sitemap]) => sitemap._route);
  for (const [, sitemap] of sitemapsWithRoutes)
    queue.push(() => nitroApp.localFetch(withLeadingSlash(sitemap._route), {}));
  setTimeout(
    () => {
      const next = async () => {
        if (queue.length === 0)
          return;
        await queue.shift()();
        setTimeout(next, 1e3);
      };
      next();
    },
    2500
    /* https://github.com/unjs/nitro/pull/1906 */
  );
});
